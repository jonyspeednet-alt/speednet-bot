<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Bot - SpeedNet AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #111827;
            --text-muted: #6b7280;
        }
        body {
            background-color: var(--bg-color);
            font-family: 'Inter', sans-serif;
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
        }
        .sidebar {
            min-height: 100vh;
            background: var(--card-bg);
            border-right: 1px solid #e5e7eb;
            width: 260px;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
        }
        .main-container {
            margin-left: 260px;
            padding: 2rem;
            width: calc(100% - 260px);
        }
        .dashboard-card {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            padding: 2.5rem;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #d1d5db;
            padding: 0.75rem 1rem;
        }
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            outline: none;
        }
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
        }
        .chat-box { height: 300px; overflow-y: auto; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; display: flex; flex-direction: column; gap: 10px; }
        .chat-bubble { padding: 10px 14px; border-radius: 12px; max-width: 80%; font-size: 0.9rem; line-height: 1.4; }
        .chat-user { background: #e0e7ff; color: #374151; align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-bot { background: #ffffff; color: #111827; align-self: flex-start; border: 1px solid #e5e7eb; border-bottom-left-radius: 2px; }
        
        .nav-link {
            color: var(--text-main);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        .nav-link:hover {
            background-color: #e0e7ff;
            color: var(--primary-color);
        }
        .nav-link.active {
            background-color: #e0e7ff;
            color: var(--primary-color);
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar p-4 d-flex flex-column">
        <h4 class="fw-bold text-primary mb-5">‚ö° SpeedNet AI</h4>
        <div class="nav flex-column nav-pills flex-grow-1">
            <a href="/dashboard" class="nav-link">üè† ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</a>
            <a href="#" class="nav-link active">‚öôÔ∏è ‡¶¨‡¶ü ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</a>
        </div>
        <button onclick="window.location.href='/dashboard'" class="btn btn-outline-secondary mt-auto w-100">‚Üê ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</button>
    </div>

    <div class="main-container">
        <div id="fb-root"></div>
        <div class="dashboard-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold mb-0">‡¶¨‡¶ü ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶®</h3>
                <span class="badge bg-success fs-6" id="pageNameBadge">Loading...</span>
            </div>

            <form id="connectForm">
                <input type="hidden" id="page_id" value="{{ page_id }}">
                <input type="hidden" id="access_token">
                <input type="hidden" id="page_name">

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="bot_name" class="form-label fw-bold">‡¶¨‡¶ü‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ (Bot Name)</label>
                            <input type="text" class="form-control" id="bot_name" value="AI Assistant" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶∏‡ßç‡¶™‡¶ø‡¶°‡¶ø" required>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="business_info" class="form-label fw-bold">‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø (Training Data)</label>
                    <textarea class="form-control" id="business_info" rows="10" required placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø, ‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ú, ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ, ‡¶Ö‡¶´‡¶æ‡¶∞ ‡¶á‡¶§‡ßç‡¶Ø‡¶æ‡¶¶‡¶ø ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..."></textarea>
                    <div class="form-text text-muted mt-2">
                        <small>‚ÑπÔ∏è ‡¶è‡¶á ‡¶§‡¶•‡ßç‡¶Ø‡ßá‡¶∞ ‡¶ì‡¶™‡¶∞ ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø ‡¶ï‡¶∞‡ßá‡¶á ‡¶è‡¶Ü‡¶á ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡¶¶‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡ßá‡¶¨‡ßá‡•§</small>
                    </div>
                </div>

                <!-- Test Chat Section -->
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header bg-white border-bottom-0 pt-3 d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0 fw-bold">ü§ñ ‡¶ü‡ßá‡¶∏‡ßç‡¶ü ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü (Preview)</h6>
                            <small class="text-muted">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá‡¶á ‡¶¨‡¶ü‡ßá‡¶∞ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á ‡¶ï‡¶∞‡ßÅ‡¶®</small>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearChat()">üóëÔ∏è Clear Chat</button>
                    </div>
                    <div class="card-body">
                        <div id="chatBox" class="chat-box mb-3">
                            <div class="text-center text-muted mt-5"><small>‡¶¨‡¶ü‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤‡¶§‡ßá ‡¶®‡¶ø‡¶ö‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®...</small></div>
                        </div>
                        <div class="input-group">
                            <input type="text" id="testMsgInput" class="form-control" placeholder="‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." onkeypress="handleEnter(event)">
                            <button class="btn btn-secondary" type="button" onclick="sendTestMessage()">‡¶™‡¶æ‡¶†‡¶æ‡¶®</button>
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary flex-grow-1 btn-lg">
                        ‡¶§‡¶•‡ßç‡¶Ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® (Update & Save)
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="disconnectPage()">
                        ‚ùå Disconnect
                    </button>
                </div>
            </form>

            <div id="message" class="mt-4 text-center"></div>
        </div>
        
        <footer class="text-center py-4 text-muted mt-auto" style="font-size: 0.85rem;">
            &copy; 2024 SpeedNet AI. All rights reserved.
        </footer>
    </div>

    <script>
        const PAGE_ID = "{{ page_id }}";
        const APP_ID = "{{ app_id }}";

        // --- Facebook SDK ---
        window.fbAsyncInit = function() {
            FB.init({
                appId      : APP_ID,
                cookie     : true,
                xfbml      : true,
                version    : 'v19.0'
            });

            FB.getLoginStatus(function(response) {
                if (response.status === 'connected') {
                    fetchPageToken();
                } else {
                    // Not logged in, redirect to dashboard
                    // alert("‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
                    // window.location.href = "/dashboard";
                }
            });
        };

        (function(d, s, id){
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) {return;}
            js = d.createElement(s); js.id = id;
            js.src = "https://connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));

        // --- Load Data ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Load existing config from DB
            try {
                const res = await fetch(`/api/company/${PAGE_ID}`);
                if (res.ok) {
                    const data = await res.json();
                    if (data.business_info) document.getElementById('business_info').value = data.business_info;
                    if (data.bot_name) document.getElementById('bot_name').value = data.bot_name;
                    if (data.page_name) {
                        document.getElementById('page_name').value = data.page_name;
                        document.getElementById('pageNameBadge').innerText = data.page_name;
                    }
                }
            } catch (e) {
                console.error("Error loading config:", e);
            }
        });

        function fetchPageToken() {
            FB.api('/me/accounts', function(response) {
                if (response && !response.error) {
                    const page = response.data.find(p => p.id === PAGE_ID);
                    if (page) {
                        document.getElementById('access_token').value = page.access_token;
                        document.getElementById('page_name').value = page.name;
                        document.getElementById('pageNameBadge').innerText = page.name;
                    }
                }
            });
        }

        // --- Form Submit ---
        document.getElementById('connectForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const msgDiv = document.getElementById('message');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ‡¶∏‡ßá‡¶≠ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';
            msgDiv.innerText = '';

            const data = {
                page_id: PAGE_ID,
                access_token: document.getElementById('access_token').value,
                bot_name: document.getElementById('bot_name').value,
                business_info: document.getElementById('business_info').value,
                page_name: document.getElementById('page_name').value
            };

            try {
                const response = await fetch('/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    msgDiv.innerHTML = `<div class="alert alert-success">‚úÖ ${result.message}</div>`;
                } else {
                    msgDiv.innerHTML = `<div class="alert alert-danger">‚ùå Error: ${result.error}</div>`;
                }
            } catch (error) {
                msgDiv.innerHTML = `<div class="alert alert-danger">‚ö†Ô∏è Network Error: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.innerText = '‡¶§‡¶•‡ßç‡¶Ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® (Update & Save)';
            }
        });

        // --- Test Chat Logic ---
        function handleEnter(e) {
            if (e.key === 'Enter') sendTestMessage();
        }

        async function sendTestMessage() {
            const input = document.getElementById('testMsgInput');
            const msg = input.value.trim();
            const businessInfo = document.getElementById('business_info').value;
            const botName = document.getElementById('bot_name').value;
            const chatBox = document.getElementById('chatBox');

            if (!msg) return;
            if (!businessInfo) { alert("‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶ó‡ßá ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§"); return; }

            // User Message
            if (chatBox.querySelector('.text-center')) chatBox.innerHTML = '';
            chatBox.innerHTML += `<div class="chat-bubble chat-user"></div>`;
            input.value = '';
            chatBox.scrollTop = chatBox.scrollHeight;

            // Loading State
            const loadingId = 'loading-' + Date.now();
            chatBox.innerHTML += `<div id="" class="chat-bubble chat-bot">...</div>`;
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                const response = await fetch('/test-chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg, business_info: businessInfo, bot_name: botName })
                });
                const data = await response.json();
                document.getElementById(loadingId).remove();
                chatBox.innerHTML += `<div class="chat-bubble chat-bot">${data.response || 'Error getting response'}</div>`;
            } catch (e) {
                document.getElementById(loadingId).remove();
                chatBox.innerHTML += `<div class="chat-bubble chat-bot text-danger">Error: ${e.message}</div>`;
            }
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function clearChat() {
            document.getElementById('chatBox').innerHTML = '<div class="text-center text-muted mt-5"><small>‡¶¨‡¶ü‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤‡¶§‡ßá ‡¶®‡¶ø‡¶ö‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®...</small></div>';
        }

        // --- Disconnect Logic ---
        async function disconnectPage() {
            if (!confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶á ‡¶™‡ßá‡¶ú‡¶ü‡¶ø ‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) return;

            try {
                const response = await fetch('/disconnect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ page_id: PAGE_ID })
                });
                if (response.ok) {
                    alert("‡¶™‡ßá‡¶ú ‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§");
                    window.location.href = "/dashboard";
                } else {
                    alert("‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§");
                }
            } catch (e) {
                alert("Network Error: " + e.message);
            }
        }
    </script>
</body>
</html>
